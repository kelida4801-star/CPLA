<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë¡€ì§‘ ì§„ë„ ì²´í¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* 1. ë””ìì¸ (CSS) ë¶€ë¶„ */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root {
            --bg: #f8f9fa; --card: #ffffff; --text: #1e272e;
            --border: #e9ecef; --shadow: rgba(0, 0, 0, 0.04);
            --primary: #3498db; --accent: #27ae60; --danger: #ff4757;
        }
        body.dark {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0;
            --border: #2d2d2d; --shadow: rgba(0, 0, 0, 0.2);
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        .header h1 { font-size: 1.6rem; font-weight: 900; margin: 0; }
        .d-day { background: var(--danger); color: white; padding: 8px 18px; border-radius: 15px; font-weight: 800; font-size: 0.95rem; }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--border); align-items: center; }
        .tab-btn { padding: 12px 25px; border: none; background: none; font-size: 1.1rem; font-weight: 800; color: #999; cursor: pointer; position: relative; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary); }
        .add-tab-btn { color: var(--accent); font-size: 1.8rem; cursor: pointer; padding: 0 15px; border: none; background: none; font-weight: bold; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); border-radius: 24px; padding: 22px; box-shadow: 0 10px 25px var(--shadow); border: 1px solid var(--border); }
        .num-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top: 15px; }
        .num-item { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; position: relative; font-weight: 600; background: var(--card); }
        .num-item.solved { color: white; }
        .num-item.starred::after { content: 'â­'; position: absolute; top: 1px; right: 1px; font-size: 0.5rem; }
        .topic-dot { position: absolute; top: 3px; right: 3px; width: 4px; height: 4px; background: #ff4757; border-radius: 50%; display: none; }
        .has-topic .topic-dot { display: block; }
        .progress-bar { height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 15px 0 8px 0; }
        .progress-fill { height: 100%; transition: 0.6s; }
        .control-panel { position: sticky; bottom: 20px; background: var(--card); padding: 15px; border-radius: 24px; display: flex; gap: 10px; border: 1px solid var(--border); z-index: 100; align-items: center; }
        .btn-extract { flex: 3; background: var(--primary); color: white; padding: 16px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; }
        #result-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 35px; border-radius: 30px; box-shadow: 0 25px 60px rgba(0,0,0,0.3); border: 3px solid var(--primary); display: none; z-index: 1100; text-align: center; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1050; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 id="main-title">ğŸ“‘ í•©ê²© ë§¤ë‹ˆì €</h1>
        <div id="dday-display" class="d-day"></div>
    </div>

    <nav class="tabs" id="tabs-list"></nav>

    <div class="config-area" style="margin-bottom: 20px;">
        <div style="font-size: 0.75rem; color: #888; background: var(--card); padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border);">
            ğŸ’¡ í´ë¦­: ì™„ë£Œ / ìš°í´ë¦­: â­ / ë”ë¸”í´ë¦­: ì£¼ì œ ì…ë ¥
        </div>
    </div>

    <div id="subjects-grid" class="grid-container"></div>

    <div class="control-panel">
        <button class="btn-theme" onclick="toggleTheme()" style="padding:10px; border-radius:10px; cursor:pointer;">ğŸŒ“ í…Œë§ˆ ì „í™˜</button>
        <button class="btn-extract" onclick="extractToday()">ì˜¤ëŠ˜ì˜ ë¬¸ì œ ì¶”ì¶œ</button>
    </div>
</div>

<div id="overlay" class="overlay" onclick="closeModal()"></div>
<div id="result-modal">
    <h2 style="color:var(--primary);">ğŸ¯ ì˜¤ëŠ˜ì˜ ë²ˆí˜¸</h2>
    <div id="result-content" style="font-size: 1.15rem; margin-bottom: 25px; font-weight: 800;"></div>
    <button onclick="closeModal()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:10px; cursor:pointer;">í™•ì¸ ì™„ë£Œ</button>
</div>

<script>
    // 2. ê¸°ëŠ¥ (JS) ë¶€ë¶„
    const firebaseConfig = {
        apiKey: "AIzaSyDdljK3SeulhUaoj3FAQRjFprifR18xKKg",
        authDomain: "cpla-study.firebaseapp.com",
        databaseURL: "https://cpla-study-default-rtdb.firebaseio.com",
        projectId: "cpla-study",
        storageBucket: "cpla-study.firebasestorage.app",
        messagingSenderId: "946106228182",
        appId: "1:946106228182:web:db39f4b37361b6c38cd877"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const dataRef = db.ref('studyData/jeonghwan'); // ì •í™˜ë‹˜ ì „ìš© ë°ì´í„° ê²½ë¡œ

    const examDate = new Date('2026-08-29'); // 2026ë…„ ê³µì¸ë…¸ë¬´ì‚¬ ì‹œí—˜ì¼
    const colorPalette = ['#ff7675', '#fab1a0', '#00b894', '#a29bfe', '#74b9ff'];
    let appData = null;

    function getDefaultSubjects() {
        return [
            { name: "ë…¸ë™ë²• 1", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[0] },
            { name: "ë…¸ë™ë²• 2", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[1] },
            { name: "ì¸ì‚¬ë…¸ë¬´ê´€ë¦¬", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[2] },
            { name: "í–‰ì •ìŸì†¡ë²•", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[3] },
            { name: "ë…¸ë™ê²½ì œí•™", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[4] }
        ];
    }

    dataRef.on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            appData = val;
            if (!appData.tabs) appData.tabs = [{ id: 'basic', name: 'ê¸°ë³¸ì„œ' }, { id: 'case', name: 'ì‚¬ë¡€ì§‘' }];
            if (!appData.books) appData.books = { 'basic': getDefaultSubjects(), 'case': getDefaultSubjects() };
        } else {
            appData = {
                activeTab: 'basic',
                tabs: [{ id: 'basic', name: 'ê¸°ë³¸ì„œ' }, { id: 'case', name: 'ì‚¬ë¡€ì§‘' }],
                books: { 'basic': getDefaultSubjects(), 'case': getDefaultSubjects() },
                history: []
            };
            save();
        }
        render();
        renderTabs();
    });

    function save() { if(appData) dataRef.set(appData); }

    function render() {
        const grid = document.getElementById('subjects-grid');
        if (!appData || !appData.books[appData.activeTab]) return;
        const subjects = appData.books[appData.activeTab];
        grid.innerHTML = subjects.map((s, idx) => {
            const solvedList = s.solved || [];
            const starredList = s.starred || [];
            const percent = ((solvedList.length / s.max) * 100).toFixed(1);
            return `
                <div class="card" style="border-top: 4px solid ${s.color}">
                    <h2 style="color:${s.color}; margin:0;">${s.name} (${s.round}íšŒë…)</h2>
                    <div class="progress-bar"><div class="progress-fill" style="width:${percent}%; background:${s.color}"></div></div>
                    <div style="font-size:0.8rem; opacity:0.7; margin-bottom:10px;">ì§„í–‰ë„: ${solvedList.length}/${s.max} (${percent}%)</div>
                    <div class="num-grid">
                        ${Array.from({length: s.max}, (_, i) => i + 1).map(n => `
                            <div class="num-item ${solvedList.includes(n) ? 'solved' : ''} ${starredList.includes(n) ? 'starred' : ''}" 
                                 style="${solvedList.includes(n) ? `background:${s.color}; color:white;` : ''}"
                                 onclick="toggleNum(${idx}, ${n})" oncontextmenu="toggleStar(event, ${idx}, ${n})">
                                 ${n}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
        updateDDay();
    }

    function renderTabs() {
        const list = document.getElementById('tabs-list');
        list.innerHTML = appData.tabs.map(t => `<button class="tab-btn ${appData.activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.name}</button>`).join('') + `<button class="add-tab-btn" onclick="addTab()">+</button>`;
    }

    function switchTab(id) { appData.activeTab = id; save(); }
    function toggleNum(idx, num) {
        const s = appData.books[appData.activeTab][idx];
        if (!s.solved) s.solved = [];
        if (s.solved.includes(num)) s.solved = s.solved.filter(n => n !== num);
        else s.solved.push(num);
        if (s.solved.length >= s.max) { s.round++; s.solved = []; alert('ğŸ‰ ë‹¤ìŒ íšŒë… ì‹œì‘!'); }
        save();
    }
    function toggleStar(e, idx, num) {
        e.preventDefault();
        const s = appData.books[appData.activeTab][idx];
        if (!s.starred) s.starred = [];
        if (s.starred.includes(num)) s.starred = s.starred.filter(n => n !== num);
        else s.starred.push(num);
        save();
    }
    function addTab() {
        const name = prompt("ì±… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (!name) return;
        const id = 'tab_' + Date.now();
        appData.tabs.push({ id, name });
        appData.books[id] = getDefaultSubjects();
        save();
    }
    function toggleTheme() { document.body.classList.toggle('dark'); }
    function closeModal() { document.getElementById('result-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    function updateDDay() {
        const diff = examDate - new Date();
        document.getElementById('dday-display').innerText = `D-${Math.ceil(diff / (1000 * 60 * 60 * 24))}`;
    }
    function extractToday() {
        const subjects = appData.books[appData.activeTab];
        let results = [];
        subjects.forEach(s => {
            const avail = Array.from({length: s.max}, (_, i) => i + 1).filter(n => !s.solved.includes(n));
            if (avail.length > 0) {
                const pick = avail[Math.floor(Math.random() * avail.length)];
                results.push(`${s.name}: ${pick}ë²ˆ`);
            }
        });
        document.getElementById('result-content').innerHTML = results.join('<br>');
        document.getElementById('result-modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }
</script>
</body>
</html>
