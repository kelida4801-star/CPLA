// 1. Firebase ì„¤ì • (ì •í™˜ë‹˜ì˜ ì„¤ì •ê°’ ìœ ì§€)
const firebaseConfig = {
    apiKey: "AIzaSyDdljK3SeulhUaoj3FAQRjFprifR18xKKg",
    authDomain: "cpla-study.firebaseapp.com",
    databaseURL: "https://cpla-study-default-rtdb.firebaseio.com",
    projectId: "cpla-study",
    storageBucket: "cpla-study.firebasestorage.app",
    messagingSenderId: "946106228182",
    appId: "1:946106228182:web:db39f4b37361b6c38cd877"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dataRef = db.ref('studyData/jeonghwan');

const examDate = new Date('2026-08-29');
const colorPalette = ['#ff7675', '#fab1a0', '#00b894', '#a29bfe', '#74b9ff'];

let appData = null;

function getDefaultSubjects() {
    return [
        { name: "ë…¸ë™ë²• 1", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[0] },
        { name: "ë…¸ë™ë²• 2", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[1] },
        { name: "ì¸ì‚¬ë…¸ë¬´ê´€ë¦¬", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[2] },
        { name: "í–‰ì •ìŸì†¡ë²•", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[3] },
        { name: "ë…¸ë™ê²½ì œí•™", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[4] }
    ];
}

// 2. ì„œë²„ ë°ì´í„° ê°ì‹œ (ì—ëŸ¬ ë°©ì§€ ë¡œì§ ë³´ê°•)
dataRef.on('value', (snapshot) => {
    const val = snapshot.val();
    if (val) {
        appData = val;
        // ë°ì´í„° ëˆ„ë½ ë°©ì§€ (ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ëŒ€ì‘)
        if (!appData.tabs) appData.tabs = [{ id: 'basic', name: 'ê¸°ë³¸ì„œ' }, { id: 'case', name: 'ì‚¬ë¡€ì§‘' }];
        if (!appData.books) appData.books = { 'basic': getDefaultSubjects(), 'case': getDefaultSubjects() };
        if (!appData.history) appData.history = [];
    } else {
        appData = {
            activeTab: 'basic',
            tabs: [{ id: 'basic', name: 'ê¸°ë³¸ì„œ' }, { id: 'case', name: 'ì‚¬ë¡€ì§‘' }],
            books: { 'basic': getDefaultSubjects(), 'case': getDefaultSubjects() },
            history: []
        };
        save();
    }
    render();
    renderTabs();
}, (error) => {
    console.error("Firebase ë¡œë“œ ì—ëŸ¬:", error);
});

function save() { if(appData) dataRef.set(appData); }

function render() {
    const grid = document.getElementById('subjects-grid');
    if (!appData || !appData.books || !appData.books[appData.activeTab]) return;

    const subjects = appData.books[appData.activeTab];
    grid.innerHTML = subjects.map((s, idx) => {
        // null ë°©ì§€ ì²˜ë¦¬: ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸([])ë¡œ ì¸ì‹í•˜ê²Œ í•¨
        const solvedList = s.solved || [];
        const starredList = s.starred || [];
        const topicsObj = s.topics || {};
        const percent = s.max > 0 ? ((solvedList.length / s.max) * 100).toFixed(1) : 0;

        return `
            <div class="card" style="border-top: 4px solid ${s.color}">
                <div class="subject-top">
                    <div class="subject-info">
                        <h2 style="color:${s.color}">${s.name}</h2>
                        <div style="margin-top:2px;">
                            <input type="number" class="input-round" style="color:${s.color}" value="${s.round || 1}" onchange="updateRound(${idx}, this.value)"> 
                            <span style="font-size:0.85rem; font-weight:700; opacity:0.6;">íšŒë… ì¤‘</span>
                        </div>
                    </div>
                    <div class="card-btn-group">
                        <button class="btn-card-action" onclick="batchCheck(${idx})">ë²”ìœ„ì²´í¬</button>
                        <button class="btn-card-action" onclick="resetSubject(${idx})" style="color:var(--danger)">ì´ˆê¸°í™”</button>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${percent}%; background:${s.color}"></div></div>
                <div class="progress-info">
                    <span>${solvedList.length} / <input type="number" class="input-round" style="width:40px; font-size:0.8rem; color:inherit;" value="${s.max || 50}" onchange="updateMax(${idx}, this.value)"> ë¬¸í•­</span>
                    <span>${percent}%</span>
                </div>
                <div class="num-grid">
                    ${Array.from({length: s.max || 50}, (_, i) => i + 1).map(n => {
                        const topic = topicsObj[n] || '';
                        const isSolved = solvedList.includes(n);
                        const isStarred = starredList.includes(n);
                        return `
                            <div class="num-item ${isSolved ? 'solved' : ''} ${isStarred ? 'starred' : ''} ${topic ? 'has-topic' : ''}" 
                                 style="${isSolved ? `background:${s.color}; color:white; border-color:${s.color};` : ''}"
                                 ${topic ? `data-topic="${topic}"` : ''}
                                 onclick="toggleNum(${idx}, ${n})" oncontextmenu="toggleStar(event, ${idx}, ${n})" ondblclick="setTopic(${idx}, ${n})">
                                 <div class="topic-dot"></div>
                                 ${n}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
    renderHistory();
    updateDDay();
}

// íƒ­ ë Œë”ë§
function renderTabs() {
    const tabsList = document.getElementById('tabs-list');
    if (!appData || !appData.tabs) return;
    tabsList.innerHTML = appData.tabs.map(tab => `
        <button class="tab-btn ${appData.activeTab === tab.id ? 'active' : ''}" onclick="switchTab('${tab.id}')">
            ${tab.name}
            <span class="del-tab" onclick="deleteTab(event, '${tab.id}')">âœ•</span>
        </button>
    `).join('') + `<button class="add-tab-btn" onclick="addTab()">+</button>`;
}

// ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ (ìˆ˜ì • ì—†ì´ ìœ ì§€ ê°€ëŠ¥)
function switchTab(id) { appData.activeTab = id; save(); }
function updateRound(idx, val) { appData.books[appData.activeTab][idx].round = parseInt(val) || 1; save(); }
function updateMax(idx, val) { appData.books[appData.activeTab][idx].max = parseInt(val) || 50; save(); }
function toggleNum(idx, num) {
    const s = appData.books[appData.activeTab][idx];
    if (!s.solved) s.solved = [];
    if (s.solved.includes(num)) s.solved = s.solved.filter(n => n !== num);
    else s.solved.push(num);
    if (s.solved.length >= s.max) { s.round++; s.solved = []; alert('ğŸ‰ ë‹¤ìŒ íšŒë… ì‹œì‘!'); }
    save();
}
function toggleStar(e, idx, num) { e.preventDefault(); const s = appData.books[appData.activeTab][idx]; if(!s.starred) s.starred = []; if(s.starred.includes(num)) s.starred = s.starred.filter(n => n !== num); else s.starred.push(num); save(); }
function setTopic(idx, num) {
    const subject = appData.books[appData.activeTab][idx];
    if (!subject.topics) subject.topics = {};
    const topic = prompt(`[${num}ë²ˆ] ì£¼ì œ ì…ë ¥:`, subject.topics[num] || "");
    if (topic !== null) { subject.topics[num] = topic; save(); }
}
function batchCheck(idx) {
    const input = prompt("ë²”ìœ„ ì…ë ¥ (ì˜ˆ: 1-10)");
    if (!input) return;
    const parts = input.split("-");
    const start = parseInt(parts[0]);
    const end = parseInt(parts[1]);
    const s = appData.books[appData.activeTab][idx];
    if (!s.solved) s.solved = [];
    for (let i = start; i <= end; i++) if (i >= 1 && i <= s.max && !s.solved.includes(i)) s.solved.push(i);
    save();
}
function resetSubject(idx) { if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) { const s = appData.books[appData.activeTab][idx]; s.solved = []; s.starred = []; s.round = 1; s.topics = {}; save(); } }
function toggleTheme() { document.body.classList.toggle('dark'); }
function closeModal() { document.getElementById('result-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
function renderHistory() {
    const hist = appData.history || [];
    document.getElementById('history-content').innerHTML = hist.length ? hist.slice(0, 5).map(h => `<div style="font-size:0.85rem; padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;"><b>${h.time}</b> <span>${h.result}</span></div>`).join('') : '<div style="text-align:center; color:#888; padding:20px;">ê¸°ë¡ ì—†ìŒ</div>';
}
function updateDDay() { const diff = examDate - new Date(); document.getElementById('dday-display').innerText = `2026 í•©ê²© D-${Math.ceil(diff / (1000 * 60 * 60 * 24))}`; }
function changeSelectiveSubject() {
    const newName = document.getElementById('selective-subject-select').value;
    if(confirm(`${newName}ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`)) { appData.books[appData.activeTab][4].name = newName; save(); }
}
function extractToday() {
    const data = appData.books[appData.activeTab];
    const isStarOnly = document.getElementById('star-mode-checkbox').checked;
    const activeTabObj = appData.tabs.find(t => t.id === appData.activeTab);
    let results = [];
    let logText = "";
    data.forEach((s, idx) => {
        let avail = [];
        const solvedList = s.solved || [];
        const starredList = s.starred || [];
        for(let i=1; i<=s.max; i++) {
            if(!solvedList.includes(i)) {
                if (isStarOnly) { if (starredList.includes(i)) avail.push(i); }
                else avail.push(i);
            }
        }
        if(avail.length > 0) {
            const p = avail[Math.floor(Math.random() * avail.length)];
            if (!s.solved) s.solved = [];
            s.solved.push(p);
            const topic = (s.topics && s.topics[p]) ? ` (${s.topics[p]})` : "";
            results.push(`<span style="color:${s.color}">${s.name}</span>: ${p}ë²ˆ${topic}`);
            logText += `${s.name}(${p}) `;
        }
    });
    if (results.length > 0) {
        if(!appData.history) appData.history = [];
        appData.history.unshift({ time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), result: `[${activeTabObj.name}] ` + logText });
        if (appData.history.length > 10) appData.history.pop();
        document.getElementById('result-content').innerHTML = results.join('<br>');
        document.getElementById('result-modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        save();
    } else alert("ì¶”ì¶œí•  ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
}
