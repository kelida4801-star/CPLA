<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë¡€ì§‘ ì§„ë„ ì²´í¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root {
            --bg: #f8f9fa; --card: #ffffff; --text: #1e272e;
            --border: #e9ecef; --shadow: rgba(0, 0, 0, 0.04); --star: #f1c40f;
            --primary: #3498db; --accent: #27ae60; --danger: #ff4757;
        }
        body.dark {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0;
            --border: #2d2d2d; --shadow: rgba(0, 0, 0, 0.2);
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        .header h1 { font-size: 1.6rem; font-weight: 900; margin: 0; letter-spacing: -1px; }
        .d-day { background: var(--danger); color: white; padding: 8px 18px; border-radius: 15px; font-weight: 800; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.2); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; padding: 0 10px; border-bottom: 2px solid var(--border); flex-wrap: wrap; align-items: center; }
        .tab-btn { padding: 12px 25px; border: none; background: none; font-size: 1.1rem; font-weight: 800; color: #999; cursor: pointer; position: relative; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary); }
        .del-tab { font-size: 0.8rem; opacity: 0.3; margin-left: 5px; transition: 0.2s; }
        .del-tab:hover { opacity: 1; color: var(--danger); }
        .add-tab-btn { color: var(--accent); font-size: 1.8rem; cursor: pointer; padding: 0 15px; border: none; background: none; font-weight: bold; line-height: 1; }
        .config-area { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; padding: 0 10px; }
        .guide-box { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .guide-text { font-size: 0.75rem; color: #888; background: var(--card); padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border); }
        select { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-weight: bold; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px; align-items: start; }
        .card { background: var(--card); border-radius: 24px; padding: 22px; box-shadow: 0 10px 25px var(--shadow); border: 1px solid var(--border); transition: 0.2s; }
        .subject-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .subject-info h2 { font-size: 1.2rem; margin: 0; font-weight: 800; }
        .input-round { width: 35px; background: transparent; border: none; color: inherit; font-weight: 800; text-align: center; font-size: 1.1rem; cursor: pointer; }
        .progress-bar { height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 15px 0 8px 0; }
        .progress-fill { height: 100%; transition: 0.6s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 600; opacity: 0.7; }
        .num-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; padding: 10px; background: rgba(0,0,0,0.015); border-radius: 12px; margin-top: 15px; }
        .dark .num-grid { background: rgba(255,255,255,0.03); }
        .num-item { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; transition: 0.15s; position: relative; font-weight: 600; background: var(--card); }
        .num-item.solved { color: white; }
        .num-item.starred::after { content: 'â­'; position: absolute; top: 1px; right: 1px; font-size: 0.5rem; z-index: 2; }
        .topic-dot { position: absolute; top: 3px; right: 3px; width: 4px; height: 4px; background: #ff4757; border-radius: 50%; display: none; z-index: 1; }
        .has-topic .topic-dot { display: block; }
        .starred .topic-dot { right: 8px; }
        .num-item[data-topic]::before { content: attr(data-topic); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; white-space: nowrap; visibility: hidden; opacity: 0; transition: 0.2s; z-index: 1000; pointer-events: none; font-weight: 400; }
        .num-item[data-topic]:hover::before { visibility: visible; opacity: 1; }
        .btn-card-action { border: 1px solid var(--border); background: var(--bg); color: #777; padding: 5px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .control-panel { position: sticky; bottom: 20px; background: var(--card); padding: 15px; border-radius: 24px; box-shadow: 0 -10px 40px var(--shadow); display: flex; gap: 10px; border: 1px solid var(--border); z-index: 100; align-items: center; }
        .btn { border: none; border-radius: 14px; cursor: pointer; font-weight: 700; transition: 0.2s; padding: 16px; }
        .btn-extract { flex: 3; background: var(--primary); color: white; font-size: 1.1rem; }
        .btn-theme { flex: 0.8; background: var(--bg); color: var(--text); border: 1px solid var(--border); font-size: 0.8rem; }
        #result-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 35px; border-radius: 30px; box-shadow: 0 25px 60px rgba(0,0,0,0.3); border: 3px solid var(--primary); display: none; z-index: 1100; text-align: center; min-width: 320px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1050; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 id="main-title">ğŸ“‘ í•©ê²© ë§¤ë‹ˆì €</h1>
        <div id="dday-display" class="d-day"></div>
    </div>

    <nav class="tabs" id="tabs-list"></nav>

    <div class="config-area">
        <div class="guide-box">
            <div class="guide-text">ğŸ’¡ í´ë¦­: ì™„ë£Œ / ìš°í´ë¦­: â­ / ë”ë¸”í´ë¦­: ì£¼ì œ ì…ë ¥</div>
            <div class="guide-text">ğŸ’¡ ì‹¤ì‹œê°„ ìë™ ë™ê¸°í™” í™œì„±í™”ë¨ (Firebase)</div>
        </div>
        <div style="display:flex; gap:10px;">
            <select id="selective-subject-select" onchange="changeSelectiveSubject()">
                <option value="ë…¸ë™ê²½ì œí•™">ë…¸ë™ê²½ì œí•™</option>
                <option value="ê²½ì˜ì¡°ì§ë¡ ">ê²½ì˜ì¡°ì§ë¡ </option>
                <option value="ë¯¼ì‚¬ì†Œì†¡ë²•">ë¯¼ì‚¬ì†Œì†¡ë²•</option>
            </select>
        </div>
    </div>

    <div id="subjects-grid" class="grid-container"></div>

    <div class="history-card" style="background: var(--card); border-radius: 20px; padding: 18px; border: 1px solid var(--border); margin-bottom: 120px;">
        <h3>ğŸ•’ ìµœê·¼ ì¶”ì¶œ ê¸°ë¡</h3>
        <div id="history-content"></div>
    </div>

    <div class="control-panel">
        <button class="btn btn-theme" onclick="toggleTheme()">ğŸŒ“ í…Œë§ˆ ì „í™˜</button>
        <div style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="star-mode-checkbox" style="width:18px; height:18px; cursor:pointer;"> 
            <span style="font-size: 0.95rem; font-weight: bold;">â­ ë³„í‘œ ì „ìš©</span>
        </div>
        <button class="btn btn-extract" onclick="extractToday()">ì˜¤ëŠ˜ì˜ ë¬¸ì œ ì¶”ì¶œ</button>
    </div>
</div>

<div id="overlay" class="overlay" onclick="closeModal()"></div>
<div id="result-modal">
    <h2 style="margin-top:0; color:var(--primary); font-size: 1.5rem;">ğŸ¯ ì˜¤ëŠ˜ì˜ ë²ˆí˜¸</h2>
    <div id="result-content" style="font-size: 1.15rem; line-height: 2; margin-bottom: 25px; font-weight: 800;"></div>
    <button class="btn btn-extract" style="padding: 12px 30px;" onclick="closeModal()">í™•ì¸ ì™„ë£Œ</button>
</div>

<script>
    // 1. Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyDdljK3SeulhUaoj3FAQRjFprifR18xKKg",
        authDomain: "cpla-study.firebaseapp.com",
        databaseURL: "https://cpla-study-default-rtdb.firebaseio.com",
        projectId: "cpla-study",
        storageBucket: "cpla-study.firebasestorage.app",
        messagingSenderId: "946106228182",
        appId: "1:946106228182:web:db39f4b37361b6c38cd877"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const dataRef = db.ref('studyData/jeonghwan');

    const examDate = new Date('2026-08-29');
    const colorPalette = ['#ff7675', '#fab1a0', '#00b894', '#a29bfe', '#74b9ff'];
    
    let appData = null;

    // ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ ê°ì‹œ
    dataRef.on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            appData = val;
            render();
            renderTabs();
        } else {
            // ì´ˆê¸° ë°ì´í„° ìƒì„±
            appData = {
                activeTab: 'basic',
                tabs: [{ id: 'basic', name: 'ê¸°ë³¸ì„œ' }, { id: 'case', name: 'ì‚¬ë¡€ì§‘' }],
                books: { 'basic': getDefaultSubjects(), 'case': getDefaultSubjects() },
                history: []
            };
            save();
        }
    });

    function getDefaultSubjects() {
        return [
            { name: "ë…¸ë™ë²• 1", max: 50, solved: [], round: 1, starred: [], topics: {}, color: colorPalette[0] },
            { name: "ë…¸ë™ë²• 2", max: 50, solved: [], round: 1, starred: [], color: colorPalette[1] },
            { name: "ì¸ì‚¬ë…¸ë¬´ê´€ë¦¬", max: 50, solved: [], round: 1, starred: [], color: colorPalette[2] },
            { name: "í–‰ì •ìŸì†¡ë²•", max: 50, solved: [], round: 1, starred: [], color: colorPalette[3] },
            { name: "ë…¸ë™ê²½ì œí•™", max: 50, solved: [], round: 1, starred: [], color: colorPalette[4] }
        ];
    }

    function save() { if(appData) dataRef.set(appData); }

    function renderTabs() {
        const tabsList = document.getElementById('tabs-list');
        tabsList.innerHTML = appData.tabs.map(tab => `
            <button class="tab-btn ${appData.activeTab === tab.id ? 'active' : ''}" onclick="switchTab('${tab.id}')">
                ${tab.name}
                <span class="del-tab" onclick="deleteTab(event, '${tab.id}')">âœ•</span>
            </button>
        `).join('') + `<button class="add-tab-btn" onclick="addTab()">+</button>`;
    }

    function render() {
        const grid = document.getElementById('subjects-grid');
        const data = appData.books[appData.activeTab];
        if (!data) return;
        grid.innerHTML = data.map((s, idx) => {
            const percent = s.max > 0 ? ((s.solved.length / s.max) * 100).toFixed(1) : 0;
            return `
                <div class="card" style="border-top: 4px solid ${s.color}">
                    <div class="subject-top">
                        <div class="subject-info">
                            <h2 style="color:${s.color}">${s.name}</h2>
                            <div style="margin-top:2px;">
                                <input type="number" class="input-round" style="color:${s.color}" value="${s.round}" onchange="updateRound(${idx}, this.value)"> 
                                <span style="font-size:0.85rem; font-weight:700; opacity:0.6;">íšŒë… ì¤‘</span>
                            </div>
                        </div>
                        <div class="card-btn-group">
                            <button class="btn-card-action" onclick="batchCheck(${idx})">ë²”ìœ„ì²´í¬</button>
                            <button class="btn-card-action" onclick="resetSubject(${idx})" style="color:var(--danger)">ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${percent}%; background:${s.color}"></div></div>
                    <div class="progress-info">
                        <span>${s.solved.length} / <input type="number" class="input-round" style="width:40px; font-size:0.8rem; color:inherit;" value="${s.max}" onchange="updateMax(${idx}, this.value)"> ë¬¸í•­</span>
                        <span>${percent}%</span>
                    </div>
                    <div class="num-grid">
                        ${Array.from({length: s.max}, (_, i) => i + 1).map(n => {
                            const topic = s.topics && s.topics[n] ? s.topics[n] : '';
                            const isSolved = s.solved && s.solved.includes(n);
                            const isStarred = s.starred && s.starred.includes(n);
                            return `
                                <div class="num-item ${isSolved ? 'solved' : ''} ${isStarred ? 'starred' : ''} ${topic ? 'has-topic' : ''}" 
                                     style="${isSolved ? `background:${s.color}; color:white; border-color:${s.color};` : ''}"
                                     ${topic ? `data-topic="${topic}"` : ''}
                                     onclick="toggleNum(${idx}, ${n})" ondblclick="setTopic(${idx}, ${n})" oncontextmenu="toggleStar(event, ${idx}, ${n})">
                                     <div class="topic-dot"></div>
                                     ${n}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');
        renderHistory();
        updateDDay();
    }

    function addTab() {
        const name = prompt("ìƒˆë¡œìš´ ì±… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (!name) return;
        const id = 'tab_' + Date.now();
        appData.tabs.push({ id, name });
        appData.books[id] = getDefaultSubjects();
        switchTab(id);
    }

    function deleteTab(e, id) {
        e.stopPropagation();
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            appData.tabs = appData.tabs.filter(t => t.id !== id);
            delete appData.books[id];
            if (appData.tabs.length > 0) switchTab(appData.tabs[0].id);
            else addTab();
        }
    }

    function switchTab(id) { appData.activeTab = id; save(); }
    function updateRound(idx, val) { appData.books[appData.activeTab][idx].round = parseInt(val) || 1; save(); }
    function updateMax(idx, val) { appData.books[appData.activeTab][idx].max = parseInt(val) || 1; save(); }
    function setTopic(idx, num) {
        const subject = appData.books[appData.activeTab][idx];
        if (!subject.topics) subject.topics = {};
        const topic = prompt(`[${num}ë²ˆ] ì£¼ì œ ì…ë ¥:`, subject.topics[num] || "");
        if (topic !== null) { subject.topics[num] = topic; save(); }
    }
    function toggleNum(idx, num) {
        const s = appData.books[appData.activeTab][idx];
        if (!s.solved) s.solved = [];
        if (s.solved.includes(num)) s.solved = s.solved.filter(n => n !== num);
        else s.solved.push(num);
        if (s.solved.length >= s.max) { s.round++; s.solved = []; alert('ğŸ‰ ë‹¤ìŒ íšŒë… ì‹œì‘!'); }
        save();
    }
    function toggleStar(e, idx, num) { e.preventDefault(); const s = appData.books[appData.activeTab][idx]; if(!s.starred) s.starred = []; if(s.starred.includes(num)) s.starred = s.starred.filter(n => n !== num); else s.starred.push(num); save(); }
    function batchCheck(idx) {
        const input = prompt("ë²”ìœ„ ì…ë ¥ (ì˜ˆ: 1-10)");
        if (!input) return;
        const [start, end] = input.split("-").map(Number);
        const s = appData.books[appData.activeTab][idx];
        for (let i = start; i <= end; i++) if (i >= 1 && i <= s.max && !s.solved.includes(i)) s.solved.push(i);
        save();
    }
    function resetSubject(idx) { if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) { const s = appData.books[appData.activeTab][idx]; s.solved = []; s.starred = []; s.round = 1; s.topics = {}; save(); } }
    function toggleTheme() { document.body.classList.toggle('dark'); }
    function closeModal() { document.getElementById('result-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    function renderHistory() { document.getElementById('history-content').innerHTML = (appData.history && appData.history.length) ? appData.history.slice(0, 5).map(h => `<div style="font-size:0.85rem; padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;"><b>${h.time}</b> <span>${h.result}</span></div>`).join('') : '<div style="text-align:center; color:#888; padding:20px;">ê¸°ë¡ ì—†ìŒ</div>'; }
    function updateDDay() { const diff = examDate - new Date(); document.getElementById('dday-display').innerText = `2026 í•©ê²© D-${Math.ceil(diff / (1000 * 60 * 60 * 24))}`; }
    function changeSelectiveSubject() {
        const newName = document.getElementById('selective-subject-select').value;
        if(confirm(`${newName}ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`)) { appData.books[appData.activeTab][4].name = newName; save(); }
    }

    function extractToday() {
        const data = appData.books[appData.activeTab];
        const isStarOnly = document.getElementById('star-mode-checkbox').checked;
        const activeTabObj = appData.tabs.find(t => t.id === appData.activeTab);
        let results = [];
        let logText = "";
        data.forEach((s, idx) => {
            let avail = [];
            for(let i=1; i<=s.max; i++) {
                if(!s.solved.includes(i)) {
                    if (isStarOnly) { if (s.starred && s.starred.includes(i)) avail.push(i); }
                    else avail.push(i);
                }
            }
            if(avail.length > 0) {
                const p = avail[Math.floor(Math.random() * avail.length)];
                s.solved.push(p);
                const topic = s.topics && s.topics[p] ? ` (${s.topics[p]})` : "";
                results.push(`<span style="color:${s.color}">${s.name}</span>: ${p}ë²ˆ${topic}`);
                logText += `${s.name}(${p}) `;
            }
        });
        if (results.length > 0) {
            if(!appData.history) appData.history = [];
            appData.history.unshift({ time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), result: `[${activeTabObj.name}] ` + logText });
            if (appData.history.length > 10) appData.history.pop();
            document.getElementById('result-content').innerHTML = results.join('<br>');
            document.getElementById('result-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            save();
        } else alert("ì¶”ì¶œí•  ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }
</script>
</body>
</html>
